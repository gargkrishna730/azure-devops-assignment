name: Azure Static Web Apps CI/CD Pipeline

on:
  push:
    branches: [ "main"]
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [ "main"]

jobs:
  # Build and Test Job
  build_and_test:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Build and Test
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ Setup Node.js (for testing tools)
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ Install testing dependencies
      run: |
        npm init -y
        npm install --save-dev puppeteer http-server
        
    - name: ğŸ§ª Run dummy tests
      run: |
        echo "ğŸš€ Starting CI/CD Pipeline Tests..."
        echo "=================================="
        
        # Test 1: Check if HTML file exists and is valid
        echo "ğŸ“„ Test 1: Checking HTML file..."
        if [ -f "index.html" ]; then
          echo "âœ… index.html exists"
        else
          echo "âŒ index.html not found"
          exit 1
        fi
        
        # Test 2: Basic HTML validation
        echo "ğŸ” Test 2: Basic HTML structure validation..."
        if grep -q "<title>" index.html && grep -q "<body>" index.html && grep -q "<script>" index.html; then
          echo "âœ… HTML structure is valid"
        else
          echo "âŒ HTML structure validation failed"
          exit 1
        fi
        
        # Test 3: Check for required content
        echo "ğŸ“ Test 3: Content validation..."
        if grep -q "Hello World" index.html && grep -q "CI/CD" index.html; then
          echo "âœ… Required content found"
        else
          echo "âŒ Required content missing"
          exit 1
        fi
        
        # Test 4: JavaScript syntax check (basic)
        echo "ğŸ”§ Test 4: JavaScript validation..."
        if grep -q "function showMessage" index.html && grep -q "function showInfo" index.html; then
          echo "âœ… JavaScript functions found"
        else
          echo "âŒ JavaScript validation failed"
          exit 1
        fi
        
        # Test 5: Simulate browser test
        echo "ğŸŒ Test 5: Browser simulation test..."
        # Start a simple HTTP server in background
        npx http-server . -p 8080 &
        SERVER_PID=$!
        sleep 3
        
        # Create a simple test script
        cat > test.js << 'EOF'
        const puppeteer = require('puppeteer');
        
        (async () => {
          const browser = await puppeteer.launch({
            headless: true,
            args: ['--no-sandbox', '--disable-setuid-sandbox']
          });
          
          try {
            const page = await browser.newPage();
            await page.goto('http://localhost:8080');
            
            // Check if page loads
            const title = await page.title();
            console.log('ğŸ“– Page title:', title);
            
            // Check if main heading exists
            const heading = await page.$eval('h1', el => el.textContent);
            console.log('ğŸ“Œ Main heading:', heading);
            
            // Test button functionality
            await page.click('button');
            console.log('ğŸ–±ï¸ Button click test passed');
            
            // Check if JavaScript is working
            const result = await page.evaluate(() => {
              return typeof showMessage === 'function' && typeof showInfo === 'function';
            });
            
            if (result) {
              console.log('âœ… JavaScript functionality test passed');
            } else {
              throw new Error('JavaScript functionality test failed');
            }
            
            console.log('ğŸ‰ All browser tests passed!');
            
          } catch (error) {
            console.error('âŒ Browser test failed:', error);
            process.exit(1);
          } finally {
            await browser.close();
          }
        })();
        EOF
        
        # Run the browser test
        node test.js
        
        # Kill the HTTP server
        kill $SERVER_PID
        
        echo "=================================="
        echo "ğŸ‰ All tests passed successfully!"
        echo "âœ¨ Ready for deployment!"
        
    - name: ğŸ“Š Generate test report
      run: |
        echo "# Test Report ğŸ“‹" > test-report.md
        echo "" >> test-report.md
        echo "**Date:** $(date)" >> test-report.md
        echo "**Commit:** ${{ github.sha }}" >> test-report.md
        echo "**Branch:** ${{ github.ref_name }}" >> test-report.md
        echo "" >> test-report.md
        echo "## Test Results âœ…" >> test-report.md
        echo "- HTML Structure Validation: âœ… Passed" >> test-report.md
        echo "- Content Validation: âœ… Passed" >> test-report.md
        echo "- JavaScript Validation: âœ… Passed" >> test-report.md
        echo "- Browser Simulation: âœ… Passed" >> test-report.md
        echo "- All Tests: âœ… **PASSED**" >> test-report.md
        
        echo "ğŸ“‹ Test report generated!"
        cat test-report.md
        
    - name: ğŸ“¤ Upload test artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: test-report.md

  # Deploy to Azure Static Web Apps
  build_and_deploy:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Deploy to Azure Static Web Apps
    needs: build_and_test
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true
        
    - name: ğŸš€ Deploy to Azure Static Web Apps
      id: builddeploy
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "/" # Location of your app source code
        api_location: "" # Location of your API source code (empty for static sites)
        output_location: "" # Location of build output relative to app_location
        
    - name: ğŸ“ Deployment summary
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸ“ App URL: "https://red-cliff-03ebb230f.1.azurestaticapps.net"
        echo "ğŸ”— You can find your actual URL in the Azure Portal"
        echo "â° Deployment time: $(date)"

  # Cleanup job for closed pull requests
  close_pull_request:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request
    
    steps:
    - name: ğŸ§¹ Close Pull Request
      id: closepullrequest
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        action: "close"
        app_location: "/" # Location of your app source code